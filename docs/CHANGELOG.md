# 更新日志

## 2025-01-30（第二批）- 解析进度与体验优化

### ✨ 新增功能

#### 1. 解析进度更细（SSE 流式）
- **功能描述**：批量解析时通过 SSE 流式返回进度，前端实时显示「已解析 3/10」
- **实现**：
  - 后端新增 `POST /api/batch_parse_stream`，返回 `text/event-stream`
  - 每解析完一条（成功或失败）推送一条 `progress` 事件，最后推送 `done` 事件
  - 前端调用 `/api/batch-parse-stream`，解析 SSE 并更新进度条
- **体验**：不再只有「解析中…」，可看到当前已解析数量与总数

#### 2. 解析并发数可调
- **功能描述**：批量解析的并发数由环境变量控制，便于在不同环境下调优
- **配置**：后端环境变量 `BATCH_PARSE_CONCURRENCY`（默认 `5`，范围 1～10）
- **使用场景**：目标站限流严时可调小（如 `3`），网络与服务器允许时可保持或调大

#### 3. 解析历史与失败重试
- **解析历史**：每次解析后，将本次请求的链接写入 localStorage（去重、新在前，最多 30 条）
  - 解析区增加「解析历史」按钮，展开后可点击某条链接填入输入框（可多选后解析）
- **失败重试**：若上次解析有失败项，显示「重试失败链接 (N)」按钮，点击后将失败链接填回输入框，便于仅重试失败项

#### 4. 预览详情一键复制
- **功能描述**：预览弹窗右侧正文区域增加「一键复制」按钮
- **行为**：点击后复制当前笔记的标题、正文、标签、来源链接到剪贴板，复制成功时按钮短暂显示「已复制」

#### 5. 下载时「同时下载文本」可选
- **笔记内下载**：预览弹窗中下载按钮旁增加「同时下载文本」勾选框（默认勾选），取消勾选后下载的 ZIP 仅包含图片，不包含 `.txt`
- **批量下载**：批量操作栏中「一键下载」旁增加「同时下载文本」勾选框，取消勾选后批量下载的每个 ZIP 均不包含文本

### 🔧 技术改进

1. **后端**
   - 批量解析并发数由硬编码 `5` 改为 `BATCH_PARSE_CONCURRENCY` 环境变量（默认 5）
   - ZIP 打包时图片由串行下载改为并发下载（每笔记最多 5 张图同时下），缩短单笔记打包时间
   - `/api/download_zip` 支持请求体参数 `include_text`（默认 `true`），为 `false` 时不往 ZIP 内写入文本文件

2. **前端**
   - 批量解析改为调用流式接口 `/api/batch-parse-stream`，解析 SSE 并实时更新「已解析 x/y」与进度条
   - 批量下载时每个笔记之间的间隔由 500ms 调整为 300ms，减少总等待时间

3. **API**
   - 新增后端 `POST /api/batch_parse_stream`（SSE）
   - 新增前端路由 `POST /api/batch-parse-stream`（代理后端流式接口）

### 📝 文档更新

- 本 CHANGELOG 已同步上述更新
- README 已补充解析进度、解析历史、一键复制、同时下载文本、环境变量等说明

---

## 2025-01-30 - 重大更新

### ✨ 新增功能

#### 1. ZIP下载功能（推荐）
- **功能描述**：所有下载现在都会自动打包成ZIP文件，直接下载到用户本地
- **优势**：
  - 不占用服务器存储空间
  - 适合 Fly.io 等临时文件系统的部署环境
  - 方便管理和分享
- **使用方法**：
  - 单个笔记：预览弹窗 → 选择图片 → 点击"下载" → 自动下载ZIP
  - 批量下载：批量选中 → 一键下载 → 依次下载多个ZIP文件
- **ZIP内容**：
  - `笔记标题.txt` - 包含标题、正文、标签、来源链接
  - `image_1.jpg`, `image_2.png` ... - 选中的图片

#### 2. Fly.io 部署支持
- **功能描述**：后端已配置支持部署到 Fly.io（免费额度 + 自动停机）
- **配置文件**：
  - `backend/Dockerfile` - Docker 镜像配置（包含 Playwright Chromium）
  - `fly.toml` - Fly.io 部署配置（自动停机、高可用）
- **部署步骤**：详见 [FLY_DEPLOY.md](./FLY_DEPLOY.md)
- **自动停机**：已配置 `min_machines_running = 0`，空闲时自动停止节省额度

#### 3. 图标选择功能
- **功能描述**：提供了 8 个不同风格的图标供选择
- **图标选项**：
  - 选项1-3：小红书风格（红色主题）
  - 选项4-8：硅谷风格（简约大方，无XHS字样）
- **预览方式**：访问 `http://localhost:3000/icon-preview.html`
- **当前应用**：选项1（现代简约风格）

#### 4. 右键粘贴支持
- **功能描述**：链接解析区域现在支持右键菜单粘贴
- **支持方式**：
  - Ctrl+V 快捷键粘贴
  - 右键菜单粘贴
  - 自动提取粘贴文本中的链接

#### 5. 文件夹选择功能（已移除UI）
- **说明**：由于改为ZIP直接下载，已移除"保存到文件夹"相关UI
- **保留**：后端接口仍保留，供本地开发使用

### 🔧 技术改进

1. **后端API优化**：
   - 新增 `/api/download_zip` 接口（ZIP下载）
   - 保留 `/api/selective_download` 接口（兼容旧版）
   - 优化错误处理和响应格式

2. **前端优化**：
   - 优化下载逻辑，支持ZIP文件下载
   - 改进批量下载体验（添加延迟避免浏览器阻止）
   - 移除不再需要的文件夹选择UI

3. **部署优化**：
   - Dockerfile 优化，支持 Fly.io 部署
   - 自动安装 Playwright Chromium
   - 配置自动停机节省资源

### 📝 文档更新

- ✅ 更新 `README.md` - 添加最新功能说明
- ✅ 更新 `FLY_DEPLOY.md` - 添加部署详细步骤
- ✅ 新增 `ICON_SELECTION.md` - 图标选择指南
- ✅ 新增 `CHANGELOG.md` - 更新日志（本文件）

### 🐛 Bug修复

1. 修复文件夹选择器错误处理
2. 修复下载文件名特殊字符处理
3. 优化错误提示信息

### 📦 依赖更新

- 后端：无需新增依赖（使用标准库 `zipfile` 和 `io`）
- 前端：无需新增依赖

---

## 使用建议

### 生产环境部署

1. **前端（Vercel）**：
   - 设置环境变量：`NEXT_PUBLIC_BACKEND_URL = https://your-fly-app.fly.dev`
   - 重新部署

2. **后端（Fly.io）**：
   - 运行 `flyctl deploy` 部署
   - 验证：访问 `https://your-app.fly.dev/docs`

### 本地开发

- 所有功能在本地开发环境同样可用
- ZIP下载功能在本地和云端都正常工作

---

**提示**：如有问题或需要帮助，请查看相关文档或联系开发者。
