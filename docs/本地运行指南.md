## XHS Factory 本地运行与迁移指南

本文档说明如何在 **本地运行整个项目（前端 + 后端）**，以及如何将项目文件夹打包迁移到另一台电脑后继续使用。

> 当前环境示例（可类比到其他电脑）：
> - 操作系统：Windows 10/11
> - 项目根目录示例：`D:\j\OpenProject\Nextproject\xhs-factory`

---

## 一、准备工作

- **必须软件（新旧电脑都需要）**：
  - 已安装 **Node.js**（建议 18+，可以在命令行输入 `node -v` 查看）
  - 已安装 **Python 3.10+**（命令行输入 `python --version` 查看）
  - 已安装 **git**（可选，用于拉取代码或版本管理）

- **项目结构简介**（核心目录）：
  - `backend/`：Python 后端（FastAPI + Playwright 爬虫）
  - `src/`：前端代码（Next.js）
  - `package.json`：前端依赖定义
  - `backend/requirements.txt`：后端依赖定义

---

## 二、如何打包项目文件夹并迁移到其他电脑

### 2.1 推荐做法：整体压缩项目目录

1. 在资源管理器中找到项目根目录，例如：
   - `D:\j\OpenProject\Nextproject\`
2. 右键项目文件夹 `xhs-factory` → 选择 “发送到 → 压缩(zipped)文件夹” 或类似选项。
3. 得到一个压缩包，例如：`xhs-factory.zip`。
4. 将 `xhs-factory.zip` 拷贝到另一台电脑（U盘 / 网盘 / 局域网传输等）。
5. 在新电脑上，将压缩包解压到一个你喜欢的位置，例如：
   - `D:\j\OpenProject\Nextproject\xhs-factory`

> 说明：`node_modules/` 可以一起打包，也可以不打包。如果不打包，解压后在新电脑上再执行 `npm install` 即可重新下载依赖。

### 2.2 迁移时需要注意的文件

**必须保留的内容：**

- 整个 `backend/` 目录（包含 `main.py`、`scraper.py`、`requirements.txt` 等）
- 整个 `src/` 目录
- `package.json` / `package-lock.json`
- `next.config.ts`、`tsconfig.json`、`tailwind.config.ts` 等配置文件
- `public/` 目录（静态资源）
- `docs/` 目录（文档）
- 根目录下的 **`run-local.bat`**（一键启动脚本，迁移到新电脑后同样可直接双击使用）

**可以在新电脑上重新生成的内容：**

- `node_modules/`（前端依赖目录）→ 重新运行 `npm install` 即可
- Python 虚拟环境目录（如 `.venv/`）→ 在新电脑上重新创建和安装依赖

---

## 三、在新电脑上首次运行前的准备（安装依赖）

以下步骤假设你已经把项目文件夹（如 `xhs-factory`）解压／复制到新电脑上。

### 3.1 前端依赖安装

1. 打开 PowerShell 或命令提示符。
2. 切换到项目根目录（根据你的实际路径调整）：

```powershell
cd D:\j\OpenProject\Nextproject\xhs-factory
```

3. 安装前端依赖（首次运行或依赖变更时需要执行一次）：

```powershell
npm install
```

### 3.2 后端依赖安装（含 Playwright 浏览器）

1. 切换到后端目录：

```powershell
cd D:\j\OpenProject\Nextproject\xhs-factory\backend
```

2. （推荐）创建并启用 Python 虚拟环境（避免污染全局 Python 环境）：

```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
```

> 如果 PowerShell 提示执行策略限制，可以以管理员身份打开 PowerShell 并执行：
>
> ```powershell
> Set-ExecutionPolicy -ExecutionPolicy RemoteSigned
> ```
> 然后重新执行激活命令。

3. 安装后端依赖：

```powershell
pip install -r requirements.txt
```

4. 安装 Playwright 所需浏览器（至少需要 Chromium）：

```powershell
playwright install chromium
```

> 这一步只在新电脑上做一次即可，后续运行无需重复安装。

---

## 四、在本地运行整个项目（开发模式）

本地运行分为两部分：**后端服务** 和 **前端服务**。一般需要开两个终端窗口。

### 4.1 启动后端（FastAPI）

1. 打开 PowerShell，切换到后端目录：

```powershell
cd D:\j\OpenProject\Nextproject\xhs-factory\backend
```

2. 如果你创建了虚拟环境，先激活它：

```powershell
.\.venv\Scripts\Activate.ps1
```

3. 启动后端服务：

```powershell
python main.py
```

4. 启动成功后，后端会在本地监听：

- 地址：`http://127.0.0.1:8000`
- 只在本机可访问，不会暴露到公网。

> 这个终端窗口需要保持打开状态，关闭则后端服务停止。

### 4.2 启动前端（Next.js 开发服务器）

1. 再打开一个新的 PowerShell 窗口。
2. 切换到项目根目录：

```powershell
cd D:\j\OpenProject\Nextproject\xhs-factory
```

3. 启动前端开发服务器：

```powershell
npm run dev
```

4. 启动成功后：

- 主页（爆款图生成器）：`http://localhost:3000`
- 爬取工具：`http://localhost:3000/crawler`

### 4.3 前后端如何连在一起？

代码中前端默认使用如下后端地址：

```ts
process.env.NEXT_PUBLIC_BACKEND_URL || "http://127.0.0.1:8000"
```

- 也就是说：**如果你没有设置 `NEXT_PUBLIC_BACKEND_URL` 环境变量，前端会自动请求本机的后端 `http://127.0.0.1:8000`**。
- 因此，在纯本地使用场景下，你 **不需要额外配置环境变量**。

### 4.4 一键启动（推荐）

不想每次手动开两个终端时，可以 **双击项目根目录下的 `run-local.bat`**：

1. **效果**：
   - 后端、前端以后台方式启动，**不再弹出两个命令行窗口**（由 `run-local.js` 启动，无窗口）。
   - 只保留一个「启动器」窗口，标题为「XHS Factory - Close this window to stop backend and frontend」。
   - 约 8 秒后自动用默认浏览器打开 `http://localhost:3000`。

2. **使用前**：请确保已按 **三** 完成过依赖安装（`npm install`、后端依赖与 `playwright install chromium`）。一键启动依赖 Node（用于运行 `run-local.js`）。

3. **关闭方式**：**关闭该启动器窗口即可同时停止后端和前端**，无需再关其他窗口。若关闭后端口仍被占用，可在任务管理器中结束残留的 `node` 或 `python` 进程。

4. **放到桌面**：可以把 `run-local.bat` 右键 → 发送到桌面快捷方式；若希望双击快捷方式也能正常启动，需在快捷方式上右键 → 属性 →「起始位置」设为项目根目录（如 `D:\j\OpenProject\Nextproject\xhs-factory`）。

> 不做成 EXE 的原因：脚本依赖本机已安装的 Python 和 Node，EXE 无法替代这两者；用 `.bat` 双击即可，无需额外打包。

---

## 五、可选：在本地以“生产模式”运行前端

如果你希望在本机体验更接近正式环境的前端（而不是开发模式），可以这样做：

1. 在一个终端中，按前文 **4.1** 的步骤启动后端服务（`python main.py`）。
2. 在另一个终端中，切换到项目根目录：

```powershell
cd D:\j\OpenProject\Nextproject\xhs-factory
```

3. 构建前端：

```powershell
npm run build
```

4. 启动前端生产服务器：

```powershell
npm start
```

5. 访问地址同样是：

- `http://localhost:3000`

> 注意：生产模式同样是只在你本机运行，不依赖 Vercel/Fly.io。

---

## 六、常见问题（FAQ）

- **Q：`npm install` 时提示有安全漏洞（vulnerabilities）或建议更新 Next.js？**  
  **A：** 这两种提示都很常见，可以按需处理：
  1. **安全漏洞**：npm 会扫描依赖中的已知漏洞并给出报告。
     - 在项目根目录执行：`npm audit` 可查看详情，`npm audit fix` 可自动修复兼容的项。
     - 若使用国内镜像（如 npmmirror），可能不支持 audit 接口，会报错，可暂时忽略或临时切回官方源：`npm config set registry https://registry.npmjs.org/` 再执行上述命令。
     - 本项目仅本地运行、不对外暴露时，风险相对可控，但建议有空时做一次 `npm audit fix`。
  2. **建议更新 Next.js**：说明当前锁定的 Next.js 版本不是最新。项目已尽量使用较新的 16.x 稳定版；若仍提示，可在项目根目录执行：
     - `npm install next@latest react@latest react-dom@latest`（升级到最新稳定版），或
     - 只升级小版本：`npm install next@16.1 eslint-config-next@16.1`。
     - 升级后建议执行一次 `npm run build` 确认能正常构建。

- **Q：迁移到新电脑后打不开 / 报错 `module not found`？**  
  **A：** 说明依赖未安装或不完整。在新电脑上重新执行：
  - 根目录：`npm install`
  - `backend/` 目录：创建虚拟环境（可选）后执行 `pip install -r requirements.txt` 和 `playwright install chromium`。

- **Q：解析时提示「访问受限：请求过于频繁」或页面显示「安全限制 / Too many requests」？**  
  **A：** 说明小红书对当前访问做了限流（错误码 300013）。建议：
  - **降低并发**：在启动后端前设置环境变量（例如在 `backend` 目录下执行）  
    `set BATCH_PARSE_CONCURRENCY=1`（PowerShell 用 `$env:BATCH_PARSE_CONCURRENCY=1`），然后 `python main.py`，这样同一时间只解析 1 条链接。
  - **间隔再试**：限流后先等几分钟，再少量解析（一次少贴几条链接）。
  - 解析失败详情中会显示「访问受限：请求过于频繁……」，可按上述方式调整后重试。
  - **反爬与稳定性相关环境变量**（在 `backend` 目录下启动前设置）：
    - `BATCH_PARSE_CONCURRENCY=1`：降低并发。
    - `CRAWL_INTERVAL_MIN=2`、`CRAWL_INTERVAL_MAX=5`：每条笔记解析后等待 2～5 秒再处理下一条。
    - `IMAGE_DOWNLOAD_DELAY_MIN=0.2`、`IMAGE_DOWNLOAD_DELAY_MAX=0.5`：下载图片时每张间隔 0.2～0.5 秒。
    - `PARSE_RETRY_TIMES=1`：单条失败时再重试 1 次（限流不会重试）。
    - `XHS_CRAWL_DEBUG=1`：输出极其详细的抓取步骤日志（goto、标题、state 等），排查「解析失败」时建议开启。

- **Q：需要一直联网吗？**  
  **A：** 项目前后端都在本机运行，不依赖云端服务；但爬虫需要访问小红书网站，因此抓取阶段需要可以访问小红书。

- **Q：数据存在哪里？换电脑会不会丢？**  
  **A：**
  - 爬到的笔记数据保存在浏览器的 `localStorage` 中，**仅存在于当前电脑、当前浏览器**。
  - 下载的 ZIP 文件保存在你的本地磁盘（通常是浏览器默认下载目录）。
  - 换电脑后，之前浏览器里的记录不会跟着走，但你可以在新电脑上重新抓取或把旧电脑上的 ZIP 手动拷贝过来。

---

## 七、一键小抄（最常用命令汇总）

> 假设项目路径为 `D:\j\OpenProject\Nextproject\xhs-factory`。

**1）首次在新电脑上准备环境：**

```powershell
cd D:\j\OpenProject\Nextproject\xhs-factory
npm install

cd backend
python -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install -r requirements.txt
playwright install chromium
```

**2）之后每次使用（本地开发模式）：**

- **方式 A（推荐）**：双击项目根目录下的 **`run-local.bat`**，等待浏览器自动打开即可。
- **方式 B（手动开两个终端）**：

  - 终端 1（后端）：

```powershell
cd D:\j\OpenProject\Nextproject\xhs-factory\backend
.\.venv\Scripts\Activate.ps1   # 如果有虚拟环境
python main.py
```

  - 终端 2（前端）：

```powershell
cd D:\j\OpenProject\Nextproject\xhs-factory
npm run dev
```

  - 然后在浏览器访问：`http://localhost:3000`（主页）、`http://localhost:3000/crawler`（爬取工具）


